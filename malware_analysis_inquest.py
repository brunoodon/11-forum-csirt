import requests
import json
import hashlib
import sys
from virus_total_apis import PublicApi as VirusTotalPublicApi
from pymisp import (MISPEvent, MISPSighting, MISPTag, MISPOrganisation, MISPObject)
from pymisp import MISPEvent, MISPObject, PyMISP, ExpandedPyMISP, MISPSharingGroup
import requests
import sys
import datetime
import json
import os
from dotenv import load_dotenv
vt_api_key = 'dc3798d6c98f2a86cffecc741200bcf4d980687190e1d12d63842aabebba3db0'
today=str(datetime.date.today())
url_hash = "https://labs.inquest.net/api/dfi/list"
headers_hash = {'Authorization': 'Basic 901bbd0f795644d29583edcb7f76758d'}
r_hash = requests.get(url_hash, headers_hash)
r_json = json.loads(r_hash.text)
misp_url = "https://misp.brunoodon.com.br"
key = '73RhcpLzFq38Ts5vLO0xhlcF4zEbRFJih8iRiKdw'
misp_verifycert = False
misp = ExpandedPyMISP(misp_url, key, misp_verifycert)
event = MISPEvent()
event.info = "Malware Analysis - File Hashes - "+today+""
event.analysis = "2"
event.published = True
event.distribution = "3"
#event.sharing_group_id = "3"
#event.threat_level_id = "1"
event.add_tag('tlp:clear')
event.add_tag('Malware')
event.add_tag('malicious')
event.add_galaxy('Attack Pattern')
#print(r_json)
try:
  for i in r_json['data']:
    if i['classification'] in 'MALICIOUS':
      filehash = str(i['sha256'])
      vt_positives =  int(i['vt_positives'])
#      print(filehash)
      vt = VirusTotalPublicApi(vt_api_key)
      response = vt.get_file_report(filehash)
      json_doc = json.dumps(response, sort_keys=False, indent=1)
#      print(json_doc)
      try:
        for x in json.loads(json_doc)['results']['scans']:
          threat_name = json.loads(json_doc)['results']['scans'][''+x+'']['result']
          if threat_name != 'None':
            print(threat_name)
            event.add_attribute('sha256', str(i['sha256']), disable_correlation=True, to_ids=False, comment='Filetype:' +str(i['file_type'])+ '|' 'Classification:'+str(i['classification'])+'|''Subcategory:' +str(i['subcategory']))
            event.add_attribute_tag(""+str(x)+":"+str(threat_name)+"", str(i['sha256']))
      except:
        print('Não tem resultado do VT')
except:
  print('Não tem resultado do inquest')
event = misp.add_event(event)
